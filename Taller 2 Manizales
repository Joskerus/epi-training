---
title: ' VBD: Construyendo un modelo simple para Zika Parte 2/3. Componente practico.'
author: "Zulma Cucunuba & Pierre Nouvellet"
authors: ["Zulma Cucunuba", "Pierre Nouvellet","José M. Velasco-España"]
date: 2022-08-04
image: img/highres/mosquito.jpg
topics: ["zika", "compartmental models","Spanish"]
categories: practicals
licenses: CC-BY
always_allow_html: yes
output:
  html_document:
  #  variant: gfm
   # preserve_yaml: yes
# params:
#   full_version: true
---

```{r options, include = FALSE, message = FALSE, warning = FALSE, error = FALSE}
library(knitr)
opts_chunk$set(collapse = TRUE)
full_version <- FALSE
```

## Objetivo general  

Aplicar los conceptos básicos del **modelado de Enfermedades Transmitidas por Vectores o VBD (por sus siglas en inglés Vector Borne Disease)** mediante el uso diagramas y formulas matemáticas con énfasis en el funcionamiento de los métodos; utilizando como ejemplo un modelo básico de infección por arbovirus.  


## Objetivos especificos

- Definir qué es un parámetro.
- Recordar conceptos como $R_0$, $R_t$, inmunidad de rebaño.
- Identificar parametros relevantes para modelar epidemias. 
- Diagramar la interacción entre los diferentes compartimentos del sistema.
- Diagramar la interacción entre los diferentes compartimentos del sistema teniendo en cuenta los parametros ahora conocidos.
- Realizar un modelo simple para la enfermedad.

En este taller (parte 2/3 de la serie de practicas de "VBD: Construyendo un modelo simple para Zika"), se comenzará por comprender como se relacionan los parametros del sistema y como se traduce a formulas matemáticas. En la siguiente practica, el participante debe construir un modelo de transmisión del Zika en R. 

## Conceptos básicos

Emplearemos estos conceptos:

- Interacción mosquito/humano
- Vectores expuestos, suceptibles e infectados
- Humanos suceptibles, infectados y recuperados


## Compartimentos del modelo básico de Zika 

- Sh : Humanos suceptibles
- Ih : Humanos infectados/infecciosos
- Rh : Humanos recuperados de la infección (inmunizados por vida)
- Sv : Vectores susceptibles
- Ev : Vectores expuestos
- Iv : Vectores infectados

## Diagrama de flujo (parte I)

En esta sección, realice un diagrama para conectar los diferentes compartimentos del modelo.

  *Pista: piense con que componentes requieren interacturar para que un humano     suceptible pase a ser un humano infectado/infeccioso.*

## Los parámetros

Son necesarios varios parámetros para conectar los diferentes compartimentos del modelo.

Revise en el material suplementario del artículo  http://science.sciencemag.org/content/early/2016/07/13/science.aag0219 y observe la tabla de parámetros de este modelo.

Busque los valores de los parámetros del modelo y diligencielos en el recuadro de abajo. Tenga en cuenta que todos los parámetros usados tienen la misma unidad de tiempo (días).

  *Pista: Como se puede observar el parametro b es una formula y no debe ser        buscado. Puede ser solucionado con los otros parámetros que encontro.*


```{r eval = FALSE}
Lv       <-        # Esperanza de vida de los mosquitos (en días)
Lh       <-        # Esperanza de vida de los humanos (en días)
Iph      <-        # Periodo infeccioso en humanos (en días)
IP       <-        # Periodo infeccioso en vectores (en días)
EIP      <-        # Período de incubación extrínseco en mosquitos adultos (en días)
muv      <-        # Mortalidad en mosquitos (1/Lv)
muh      <-        # Mortalidad en humanos (1/Lh)
gamma    <-        # Tasa de recuperación en humanos (1/Iph)
delta    <-        # Tasa de incubación extrínseca (1/EIP)
betah    <-        # Probabilidad de transmisión del vector al hospedador
betav    <-        # Probabilidad de transmisión del hospedador al vector
Nh       <-        # Número de humanos (Población de Cali 2.4 millones)
m        <-        # Proporción vector a humano
Nv       <-        # Número de vectores (m * Nh)
R0       <-        # Número reproductivo
b        <-        sqrt((R0 ^2 * muv*(muv+delta) * (muh+gamma)) /
                   (m * betah * betav * delta)) # Tasa de picadura

TIME     <-        # Número de años que se va a simular 

```


## Modelo (Ecuaciones)

###  Humanos

$$\ \frac{dSh}{dt}  = \mu_h N_h - \frac {\beta_h b}{N_h} S_h  I_v - \mu_h  S_h $$    
$$\ \frac{dIh}{dt}  = \frac {\beta_h b}{N_h}S_h I_v - (\gamma_h + \mu_h) I_h $$    
$$\ \frac{dRh}{dt}  = \gamma_h I_h  - \mu_h R_h$$    

###  Vectores      

$$\ \frac{dSv}{dt}  = \mu_v N_v  - \frac{\beta_v b} {N_h} I_h S_v - \mu_v Sv$$    
$$\ \frac{dE_v}{dt}  = \frac{\beta_v b} {N_h} I_h S_v - (\delta + \mu_v) Ev$$    
$$\ \frac{dI_v}{dt}  = \delta Ev - \mu_v I_v$$   


## Estimemos $R_0$ (Número reproductivo)

Formula necesaria para estimar $R_0$: 

$$ R_0^2 = \frac{mb^2 \beta_h \beta_v \delta}{\mu_v (\mu_v+\delta)(\mu_h+\gamma_h)} $$

## Diagrama de flujo (parte II)

Ahora que conoce las ecuaciones, complete el diagrama de flujo con los parámetros y la conexión correcta entre los diferentes compartimentos.

  *Pista: En la formula $$\ \frac{dSh}{dt}  = \mu_h N_h - \frac {\beta_h b}{N_h} S_h  I_v - \mu_h  S_h $$ La expresión $\frac{dSh}{dt}$  se refiere al cambio de los humanos suceptibles en el tiempo. Podemos ver que la formula empieza con $\mu_h N_h$, es decir, en un punto 0 o al inicio tendremos como humanos suceptibles la población de la zona multiplicada por la mortalidad en humanos. Esta expresión se ve modificada por dos expresiones que restan a esta cantidad inicial. Bajo la expresión $- \frac {\beta_h b}{N_h} S_h  I_v$ encontramos que la población suceptible disminuye conforme humanos suceptibles pasan al estado de infectados principalmente por la probabilidad de transmisión del vector al hospedador y bajo la expresión $- \mu_h  S_h$ encontramos que nuevamente esta población disminuye por la muerte en el tiempo de esta población (mediada por la esperanza de vida).*

```{r, include = full_version}
# Parámetros
Lv       <- 10        # Esperanza de vida de los mosquitos (en días)
Lh       <- 50 * 365  # Esperanza de vida de los humanos (en días)
Iph      <- 7         # Periodo infeccioso en humanos (en días)
IP       <- 6         # Periodo infeccioso en vectores (en días)
EIP      <- 8.4       # Período de incubación extrínseco en mosquitos adultos
muv      <- 1/Lv      # Mortalidad en mosquitos
muh      <- 1/Lh      # Mortalidad en humanos
gamma    <- 1/Iph     # Tasa de recuperación en humanos
delta    <- 1/EIP     # Tasa de incubación extrínseca


# Tamaño de la población
Nh       <- 2.4 * 10^6# Número de humanos (Población de Cali, Colombia)
m        <- 2         # Proporción vector a humano
Nv       <- m * Nh    # Número de vectores
betah    <- 0.7       # Probabilidad de transmisión del vector al hospedador
betav    <- 0.7       # Probabilidad de transmisión del hospedador al vector 
R0       <- 3         # Número reproductivo
b        <- sqrt((R0 ^2 * muv*(muv+delta) * (muh+gamma)) /
                   (m * betah * betav * delta)) # tasa de picadura

TIME     <- 100       # Número de años a simular

```

## Para finalizar, interprete las siguientes gráficas

A continuación, se presenta el comportamiento de estos parámetros en un tiempo de 100 años. 
¿Cómo cree que fue el modelo en el primer año? 
¿Qué significan las ondulaciones de la curva de población humana suceptible?


```{r include=FALSE}
library(deSolve)
library(ggplot2)
library(gridExtra)
```
```{r, include = full_version}
arbovmodel <- function(t, x, params) {
  
  Sh <- x[1]    # Humanos susceptibles
  Ih <- x[2]    # Humanos infectados 
  Rh <- x[3]    # Humanos recuperados
  Sv <- x[4]    # Vectores susceptibles
  Ev <- x[5]    # Vectores expuestos
  Iv <- x[6]    # Vectores infectados
  
  with(as.list(params), # entorno local para evaluar derivados
       {
         # Humans
         dSh   <-  muh * Nh - (betah * b/Nh) * Sh * Iv - muh * Sh   
         dIh   <-  (betah * b/Nh) * Sh * Iv  - (gamma + muh) * Ih
         dRh   <-  gamma * Ih  - muh * Rh
         
         # Vectors
         dSv   <-  muv * Nv - (betav * b/Nh) * Ih * Sv - muv * Sv 
         dEv   <-  (betav * b/Nh) * Ih * Sv - (delta + muv)* Ev
         dIv   <-  delta * Ev - muv * Iv
         
         dx    <- c(dSh, dIh, dRh, dSv, dEv, dIv)
         list(dx)
       }
  )
}
```


```{r, include = full_version}
# ----------- Resuelva el modelo
times  <- seq(1, 365 * TIME , by = 1)

# Especifique los parámetros
params <- c(
  muv      = muv,     
  muh      = muh,     
  gamma    = gamma,   
  delta    = delta,   
  b        = b,       
  betah    = betah,   
  betav    = betav,   
  Nh       = Nh,      
  Nv       = Nv)


# Condiciones iniciales del sistema
xstart<- c(Sh = Nh ,      # Initial number of Sh at T0
           Ih = 0,        # Initial number of Ih at T0
           Rh = 0,        # Initial number of Rh at T0
           Sv = Nv-1,     # Initial number of Sv at T0
           Ev = 0,        # Initial number of Ev at T0
           Iv = 1)        # Initial number of Iv at TO

# Resuelva las ecuaciones
out <- as.data.frame(ode(y      = xstart,     # Condiciones iniciales
                         times  = times,      # Veces
                         fun    = arbovmodel, # Modelo
                         parms  = params))    # Parámetros


# Cree las opciones de tiempo a mostrar
out$years <- out$time / 365
out$weeks <- out$time / 7
```


### Comportamiento General (Población humana)

```{r p1, echo=FALSE}
# Revise el comportamiento general del modelo para 100 años

p1h <- ggplot(data = out, aes(y = (Rh + Ih + Sh)/10000, x = years)) +
  geom_line(color = 'grey68', size = 1) +
  ggtitle('Población humana total') +
  theme_bw() + ylab('number per 10,000')

p2h <- ggplot(data = out, aes(y = Sh/10000, x = years)) +
  geom_line(color = 'royalblue', size = 1) +
  ggtitle('Población humana susceptible') +
  theme_bw() + ylab('number per 10,000')

p3h <- ggplot(data = out, aes(y = Ih/10000, x = years)) +
  geom_line(color = 'firebrick', size = 1) +
  ggtitle('Población humana infectada') +
  theme_bw() + ylab('number per 10,000')

p4h <- ggplot(data = out, aes(y = Rh/10000, x = years)) +
  geom_line(color = 'olivedrab', size = 1) +
  ggtitle('Población humana recuperada') +
  theme_bw() + ylab('number per 10,000')


grid.arrange(p1h, p2h, p3h, p4h, ncol = 2)
```


### Comportamiento General (Población de vectores)

```{r p2, echo=FALSE}
# Revise el comportamiento general del modelo

p1v <- ggplot(data = out, aes(y = (Sv + Ev + Iv), x = years)) +
  geom_line(color = 'grey68', size = 1) +
  ggtitle('Población total de mosquitos') +
  theme_bw() + ylab('number')

p2v <- ggplot(data = out, aes(y = Sv, x = years)) +
  geom_line(color = 'royalblue', size = 1) +
  ggtitle('Población susceptible de mosquitos') +
  theme_bw() + ylab('number')

p3v <- ggplot(data = out, aes(y = Ev, x = years)) +
  geom_line(color = 'orchid', size = 1) +
  ggtitle('Población expuesta de mosquitos') +
  theme_bw() + ylab('number')

p4v <- ggplot(data = out, aes(y = Iv, x = years)) +
  geom_line(color = 'firebrick', size = 1) +
  ggtitle('Población infectada de mosquitos') +
  theme_bw() + ylab('number')

grid.arrange(p1v, p2v, p3v, p4v, ncol = 2)
```



### Proporción 

Vamos a dar una mirada más cuidadosa a las proporciones y discutámoslas 

```{r p3, echo=FALSE}

p1 <- ggplot(data = out, aes(y = Sh/(Sh+Ih+Rh), x = years)) +
  geom_line(color = 'royalblue', size = 1) +
  ggtitle('Población humana susceptible') +
  theme_bw() + ylab('proportion')

p2 <- ggplot(data = out, aes(y = Ih/(Sh+Ih+Rh), x = years)) +
  geom_line(color = 'firebrick', size = 1) +
  ggtitle('Población humana infectada') +
  theme_bw() + ylab('proportion')

p3 <- ggplot(data = out, aes(y = Rh/(Sh+Ih+Rh), x = years)) +
  geom_line(color = 'olivedrab', size = 1) +
  ggtitle('Población humana recuperada') +
  theme_bw() + ylab('proportion')

grid.arrange(p1, p2, p3, ncol = 2)

```


### La primera epidemia 

```{r p4, echo=FALSE}
# Revise la primera epidemia

dat <- out[out$weeks < 54, ]

p1e <- ggplot(dat, aes(y = Ih/10000, x = weeks)) +
  geom_line(color = 'firebrick', size = 1) +
  ggtitle('Población de humanos infectados') +
  theme_bw() + ylab('número por 10,000')


p2e <- ggplot(dat, aes(y = Rh/10000, x = weeks)) +
  geom_line(color = 'olivedrab', size = 1) +
  ggtitle('Población humana recuperada') +
  theme_bw() + ylab('number per 10,000')


grid.arrange(p1e, p2e)
```


## Sobre este documento

### Contribuciones

- Zulma Cucunuba & Pierre Nouvellet: Versión incial
- Kelly Charinga & Zhian N. Kamvar: Edición
- José M. Velasco-España: Traducción de Inglés a Español y Ediciones menores
- Andree Valle-Campos: Ediciones menores

Contribuciones son bienvenidas vía [pull requests](https://github.com/reconhub/learn/pulls). El archivo fuente del documento original puede ser encontrado [**aquí**](https://raw.githubusercontent.com/reconhub/learn/master/content/post/practical-vbd.Rmd).



### Asuntos legales

**Licencia**: [CC-BY](https://creativecommons.org/licenses/by/3.0/)
**Copyright**: Zulma Cucunuba & Pierre Nouvellet, 2017


<!-- ## Referencias -->
